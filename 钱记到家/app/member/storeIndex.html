<!DOCTYPE html>
<html>

<head>
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta charset="UTF-8">
    <title>商家小店</title>
    <link rel="stylesheet" type="text/css" href="/css/global.css" />
    <link rel="stylesheet" href="/js/layer_mobile/need/layer.css" />
    <link rel="stylesheet" href="/css/details.css" />
    <link rel="stylesheet" href="/css/style.css" />
    <link rel="stylesheet" type="text/css" href="/css/dd_style.css" />
    <link rel="stylesheet" type="text/css" href="../css/fenxiang.css" />
    <script type="text/javascript" src="/js/jquery.min.js"></script>
    <script type="text/javascript" src="/script/dropload.min.js" charset="utf-8"></script>
    <script type="text/javascript" src="/js/layer_mobile/layer.js"></script>
    <script src="/js/iscroll.js" type="text/javascript" charset="utf-8"></script>
    <script src="/js/navbarscroll.js" type="text/javascript" charset="utf-8"></script>
    <script src="/js/doT.min.js" type="text/javascript" charset="utf-8"></script>
    <script src="/js/sc.core.js" type="text/javascript" charset="utf-8"></script>
    <script src="/script/wxlogin.js?4"></script>
    <script src="/js/resetFontSize.js?0" type="text/javascript"></script>
    <script src="/script/laytpl.js" type="text/javascript" charset="utf-8"></script>
    <script src="/script/coupon.js" type="text/javascript" charset="utf-8"></script>
    <script src="/script/sku.js" type="text/javascript" charset="utf-8"></script>
    <script src="/script/addCart.js" type="text/javascript" charset="utf-8"></script>
    <script src="../script/Share.js" type="text/javascript" charset="utf-8"></script>
    <script src="../script/WxShare.js" type="text/javascript" charset="utf-8"></script>
    <style type="text/css">
        .fixedStoreIndexTop {
            height: 1.02rem;
        }

        .storeIndexTop {
            position: fixed;
            left: 0;
            right: 0;
            width: 100%;
            max-width: 750px;
            margin: 0 auto;
            z-index: 8;
        }

        .navFixed {
            height: .42rem;
            position: relative;
            overflow: hidden;
        }

        .nav-wrap {
            /*position: fixed;*/
            overflow: hidden;
            height: .42rem;
            left: 0;
            right: 0;
            width: 100%;
            max-width: 750px;
            margin: 0 auto;
            background-color: #fff;
            z-index: 8;
            top: 1.47rem;
        }

        .classifyNavBox {
            position: absolute;
        }

            .classifyNavBox .dd_tabList {
                display: block;
            }

                .classifyNavBox .dd_tabList li {
                    float: left;
                }

                    .classifyNavBox .dd_tabList li a {
                        margin: 0 .08rem;
                    }

        .storeIndexTop .tx_info .info,
        .storeIndexTop .tx_info {
            -webkit-box-flex: 1;
            -webkit-flex: 1;
            flex: 1;
            -moz-flex: 1;
            -ms-flex: 1;
            -o-flex: 1;
            overflow: hidden;
        }

            .storeIndexTop .tx_info .info {
                position: relative;
            }

                .storeIndexTop .tx_info .info p {
                    white-space: nowrap;
                    text-overflow: ellipsis;
                    overflow: hidden;
                }

        .couponList {
            padding-top: 0;
            padding-bottom: 0;
            margin-bottom: .1rem;
        }

            .couponList .item {
                margin: .1rem 0 0 0;
            }

            .couponList .linkbtn {
                display: block;
                height: .3rem;
                line-height: .3rem;
                width: 1rem;
                text-align: center;
                margin: .1rem auto 0;
                border: 1px solid #ff4e17;
                border-radius: 4px;
            }

        .storeIndexTop .btn.flow {
            display: block;
            position: absolute;
            right: 0;
            top: .02rem;
            height: .26rem;
            line-height: .24rem;
            padding: 0 .1rem;
            border: .01rem solid #ff5c29;
            background: transparent;
            color: #ff5c29;
            border-radius: .13rem;
        }
    </style>

</head>

    <body class="bg_gray ac">
        <div class="h45">
            <div class="head">
                <a href="javascript:history.go(-1);" class="btn_back"></a>
                <div class="title center">商家小店</div>
                <a href="javascript:;" class="icon_r icons_share sharebtn"></a>
            </div>
        </div>

        <div class="main">
            <div class="fixedStoreIndexTop">
                <div class="storeIndexTop img" style="background-image: url(/images/of/storeIndexTop.jpg);">
                    <div class="inner">
                        <div class="tx_info">
                            <div class="tx">
                                <img src="/images/tx/default.png" id="Avatar" alt="">
                            </div>
                            <div class="info">
                                <p class="name" id="shopNick"></p>
                                <p id="shopAbout">优惠多多 实惠每天</p>
                                <a href="javascript:;" class="btn flow" id="isCollectionShop">关注</a>
                            </div>
                        </div>

                    </div>
                </div>
                <div id="storeIndexTopInfo"></div>

            </div>
            <!--优惠券-->
            <div class="couponList" id="couponList1">

            </div>

            <!--商品分类排版-->
            <div class="navFixed">
                <div class="nav-wrap" id="Scroller">
                    <div class="wrap classifyNavBox"></div>
                </div>
            </div>
            <!--显示区域-->
            <div class="productWrap" style="padding:.1rem .1rem 0;">
                <div class="productListBox">
                    <div class="sectionBd"><ul class="prolist li50 clear"></ul></div>
                </div>
            </div>
            <!--显示区域  end-->
            <!--商品分类排版  end-->
        </div>
        <!-- 加入购物车的弹出sku选择-->
        <div class="shade sku__shade">
            <div class="shadebg"></div>
            <div class="shade_content">
                <div class="shade-item specifications_shade">
                    <span class="btn-close"></span>
                    <div class="productInfo">
                        <div class="m-pro clear">
                            <div class="hd fl">
                                <div class="img">
                                    <img src="">
                                </div>
                            </div>
                            <div class="bd">
                                <h4 class="name"></h4>
                                <p class="desc">
                                    <span>库存：<span id="stock"></span>件</span>
                                </p>
                                <p class="price">
                                    <span>￥<span id="new_price"></span></span><span class="counterPrice">￥<span id="old_price"></span></span>
                                </p>
                            </div>
                        </div>
                    </div>
                    <div class="shade_bd">
                        <div id="skuBoxContent"></div>
                        <div class="skuBox buyNum_skuBox clear">
                            <h2 class="skuTitle fl">购买数量</h2>
                            <div class="flexItem fr">
                                <div class="selnum">
                                    <span class="less btn-num icon-minus"></span>
                                    <div class="textWrap">
                                        <input type="text" id="pro_num" readonly="readonly">
                                    </div>
                                    <span class="more btn-num icon-add"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="shade_ft">
                        <a href="javascript:;" class="btn_100 btn-sure btn-qybuy" id="addCart">确定</a>

                    </div>
                </div>
            </div>
        </div>
        <!--弹出sku选择 end-->


        <div class="fenxiang">
            <div>
                <p class="fenxiang-title">分享小店</p>
                <div class="bdsharebuttonbox">
                    <ul class="gb_resItms">
                        <li>
                            <a title="分享到微信" href="#" class="bds_weixin " data-cmd="weixin" data-url=""></a>微信好友
                        </li>
                        <li>
                            <a title="分享到QQ好友" href="#" class="bds_sqq " data-cmd="sqq" data-url=""></a>QQ好友
                        </li>
                        <li>
                            <a title="分享到QQ空间" href="#" class="bds_qzone " data-cmd="qzone" data-url=""></a>QQ空间
                        </li>
                        <li>
                            <a title="分享到新浪微博" href="#" class="bds_tsina " data-cmd="tsina" data-url=""></a>新浪微博
                        </li>
                    </ul>
                </div>
                <p class="fenxiang-colse">取消</p>
            </div>
        </div>

        <!--分类模板-->
        <script id="shopClassifyTemp" type="text/x-dot-template">

            <ul class="dd_tabList bb__tabList clear">
                {{~it:value:index}} {{ if(index==0){ }}
                <li class="active" data-id="{{=value.Id}}">
                    <a href="javascript:;" class="ouside">{{=value.ClassName}}</a>
                </li>
                {{ }else{ }}
                <li data-id="{{=value.Id}}">
                    <a href="javascript:;" class="ouside">{{=value.ClassName}}</a>
                </li>
                {{ } }} {{~}}
            </ul>

        </script>
        <!--分类模板  end-->
        <!--产品列表模板-->
        <script id="shopProductListTemp" type="text/x-dot-template">
            {{~it:value:index}}
            <li>
                <a href="/details.html?id={{=value.Id}}" class="m-pro" data-id="{{=value.Id}}">
                    <div class="hd">
                        {{ if(value.IsHot){ }}
                        <div class="mark hot"><span>热卖</span></div>
                        {{ } }}
                        <div class="img">
                            {{ if(value.ProductImg){ }}
                            <img src="{{=value.ProductImg}}">
                            {{ }else{ }}
                            <img src="/images/noPic.jpg">
                            {{ } }}
                        </div>
                    </div>
                    <div class="bd">
                        <h4 class="name">{{=value.Name}}</h4> {{? value.Synopsis}}
                        <p class="desc">{{=value.Synopsis}}</p>
                        {{??}}
                        <p class="desc">暂无产品简介</p>
                        {{?}}
                        <p class="price">￥{{=value.Price}}</p>
                        <p class="Tags">{{? value.DiscountNum && value.DiscountNum<10}}<span class="rebate">{{=value.DiscountNum}}折</span>{{?}}<span class="counterPrice">￥{{=value.MarketPrice}}</span></p>
                        <span class="buybtn"></span>
                    </div>
                </a>
            </li>
            {{~}}
        </script>
        <!--产品列表模板 end-->
        <!--优惠券列表模板 start-->
        <script type="text/html" id="couponLtpl">
            {{# for(var i = 0; i < d.length; i++){ }}
            {{#  if(i==0){ }}
            {{#  if(d[i].IsMyAlready===false){ }}
            <div class="item false__item" data-id="{{d[i].Id}}" data-limit="{{d[i].Limit}}">
                {{#  } else { }}
                <div class="item" data-id="{{d[i].Id}}" data-limit="{{d[i].Limit}}">
                    {{#  } }}
                    <div class="left">
                        {{#  if(d[i].DiscountType==="2"){ }}
                        {{
#
						  function rebate(){
						  	var number = d[i].Denomination*10;
						    return number;
						  }
                        }}
                        <span class="priceArea left_priceArea center">{{rebate()}}<span class="fh">折</span></span>
                        {{#  } else { }}
                        <span class="priceArea left_priceArea center"><span class="fh">￥</span>{{d[i].Denomination}}</span>
                        {{#  } }}
                        <div class="titleBox">
                            <p class="useNeed">
                                <span>{{d[i].UseExplain}}</span>
                            </p>
                            <span class="title">{{d[i].Name}}</span>
                        </div>
                        <p class="validTime">有效日期：{{d[i].StartTime.split(" ")[0]}}-<span class="endTime">{{d[i].EndTime.split(" ")[0]}}</span></p>
                    </div>
                    <div class="right">
                        <span class="type">优惠券</span>
                    </div>
                </div>
                {{# } }}
                {{# } }}
        </script>
        <!--优惠券列表模板 end-->
        <script type="text/javascript">
            var userId = sc.utils.getCookieValue("UserId");
            var token = sc.utils.getCookieValue("Token");
            var shopId = sc.utils.getQueryString("shopId");
            var classTypeId;
            var pageNum = 0; //当前页
            var pageSize = 10;
            $(function () {
                // 修改分享小店按钮
                var shareUrl = 'http://www.qianjidaojia.com/member/storeIndex.html?shopId=' + shopId + '&id=';
                console.log('shareUrl1' + shareUrl);
                $(".fenxiang a").attr("data-url", shareUrl);
                console.log('shareUrl2' + $(".fenxiang a").attr('data-url'));

                //判断店铺是否收藏
                if (sc.auth.isLogin()) {
                    shopIscollect();
                }
                CouponCenter(0,"",shopId, 1, pageSize, function (data) {
                    if (data.data.length > 0) {
                        var couponLtpl = document.getElementById('couponLtpl').innerHTML;
                        laytpl(couponLtpl).render(data.data, function (html) {
                            //得到的模板渲染到html
                            document.getElementById('couponList1').innerHTML = html;
                            $(".item").each(function () {
                                $(this).click(function () {
                                    var CouponId = $(this).attr("data-id");
                                    ReceiveCoupon($(this), CouponId, 0);
                                })
                            })
                        });
                        if (data.data.length > 1) {
                            $('#couponList1').append('<a href="shopmanCoupon.html?shopId=' + shopId + '" class="linkbtn c_Org">更多优惠券</a>')
                        }
                    }
                }, function (data) {
                    //错误
                })
                getMerchantDetail();
                shopClassify();
                window.onscroll = function () {
                    if (($(this).scrollTop() + $('.head').height() + 45) >= $('.navFixed').offset().top) {
                        $('.navFixed').children(".nav-wrap").addClass('fixed');
                    }
                    else {
                        $('.navFixed').children(".nav-wrap").removeClass('fixed');
                    }
                }

            });

            //获取店铺详情
            function getMerchantDetail() {
                var url = 'api/Shop/GetMerchantDetail';
                var callback = function (data) {
                    console.log(data);
                    if (data.code == 0) {
                        $('#shopNick').text(data.data.ShopNick);
                        $('#shopAbout').text(data.data.Description);
                        if (!data.data.Logo) {
                            $('#Avatar').attr("src", '/images/tx/default.png');
                        } else {
                            $('#Avatar').attr("src", data.data.Logo);
                        }
                        //收藏店铺
                        $("#isCollectionShop").click(function () {
                            var id = sc.utils.getQueryString("shopId")
                            $(this).toggleClass("active");
                            if (sc.auth.isLogin()) {
                                if ($(this).hasClass("active")) {
                                    //取消关注店铺
                                    shopCollection(id);
                                } else {
                                    //关注店铺
                                    shopCollection(id);
                                }
                                shopIscollect();

                            } else {
                                layer.open({
                                    content: '您还没有登录，是否要登录？',
                                    btn: ['确定', '取消'],
                                    yes: function (index) {
                                        window.location.href = "/login.html?returnUrl=" + sc.utils.getCurrentPathname();
                                        layer.close(index);
                                    },
                                    no: function (index) {
                                        layer.close(index);
                                    }
                                });
                            }


                        });

                    } else if (data.code == 1) {
                        layer.open({
                            content: data.msg,
                            skin: 'msg',
                            time: 2 //2秒后自动关闭
                        });
                    } else if (data.code == 99) {
                        layer.open({
                            content: '服务器开了个小差!',
                            skin: 'msg',
                            time: 2 //2秒后自动关闭
                        });
                    }
                }
                sc.post(url, {
                    "shopId": shopId
                }, callback);
            }

            //店铺的产品分类
            function shopClassify() {
                var url = 'api/Goods/GetProductClass';
                var callback = function (data) {
                    if (data.code == 0) {
                        if (data.data.length) {
                            var interText = doT.template($("#shopClassifyTemp").text());
                            $(".classifyNavBox").html(interText(data.data));
                            classTypeId = $('.classifyNavBox .dd_tabList li').eq(0).attr("data-id");
                            var _index = $(".nav-wrap li.active").index();
                            $('.nav-wrap').navbarscroll({
                                fingerClick: 1,
                                defaultSelect: _index
                            });

                            PageshopProductList(classTypeId);
                            $('.classifyNavBox .dd_tabList li').click(function () {
                                classTypeId = $(this).attr('data-id');
                                pageNum = 0;
                                $(".prolist").html("");
                                $(this).addClass('active').siblings().removeClass('active');
                                PageshopProductList(classTypeId);
                            });
                        }
                    }

                }
                sc.post(url, {
                    "shopId": shopId
                }, callback);
            }

            function PageshopProductList(Pid) {
                //初始化
                var pageNum = 0,
                    pageSize = 6;

                $(".dropload-down").remove();
                $('.productListBox').dropload({
                    scrollArea: window,
                    domDown: {
                        domClass: 'dropload-down',
                        domRefresh: '<div class="dropload-refresh">↑上拉加载更多</div>',
                        domLoad: '<div class="dropload-load"><span class="loading"></span>加载中...</div>',
                        domNoData: '<div class="dropload-noData">已经到底了</div>'
                    },
                    loadDownFn: function (me) {
                        pageNum++;
                        shopProductList(Pid, pageNum, pageSize, function (data) {
                            //var interText = doT.template($("#shopProductListTemp").text());
                            if (data.data.length == 0 && !data.isok) {
                                me.lock();
                                me.noData();
                                me.resetload();
                                if (pageNum == 1) {
                                    $(".dropload-down").remove();
                                    var emptystr = "";
                                    emptystr += '<div class="emptybox">';
                                    emptystr += '<div class="iconimg"><img src="/images/icons/empty2.png"/></div>';
                                    emptystr += '<p class="tips">暂无数据 </p>';
                                    emptystr += '</div>';
                                    $('.prolist').html(emptystr);
                                }
                            }
                            else if (data.data.length < pageSize) {
                                //								setTimeout(function () {
                                var interText = doT.template($("#shopProductListTemp").text());
                                $(".prolist")[0].innerHTML += interText(data.data);
                                me.lock("down");
                                me.noData();
                                //								},1000);
                                me.resetload();
                            }
                            else {
                                if (pageNum == 1) {
                                    $(".prolist").html("");
                                }
                                //								setTimeout(function () {
                                var interText = doT.template($("#shopProductListTemp").text());
                                $(".prolist")[0].innerHTML += interText(data.data);

                                //								},1000);
                                me.resetload();
                            }
                        }, me)
                    }
                })


            }

            //产品列表
            function shopProductList(Pid, pageNum, pageSize, successCallback, el) {
                var url = 'api/Goods/GoodsList';
                var callback = function (data) {
                    console.log(data);
                    if (data.code == 0) {
                        successCallback(data);
                    }

                }
                var error = function (data) {
                    el.resetload();
                }
                sc.post(url, {
                    "cid": Pid,
                    "sortorder": 0,
                    "page": pageNum,
                    "pageSize": pageSize,
                    "shopId": shopId
                }, callback, error);
            }
            //店铺收藏
            function shopCollection(shopid) { //type=0;取消 type=1为关注
                var url = "api/Goods/ShopCollection";
                var calback = function (data) {
                    if (data.code == 0) {
                        shopIscollect();
                        layer.open({
                            content: data.msg,
                            skin: 'msg',
                            time: 2 //2秒后自动关闭
                        });
                    }

                };
                sc.post(url, {
                    "UserId": userId,
                    "Token": token,
                    "shopId": shopid
                }, calback);
            }
            //获取商家收藏状态
            function shopIscollect() {
                var url = "api/Shop/ShopIsCollect";
                var calback = function (data) {
                    console.log(data.code);
                    if (data.code == 0) {
                        $("#isCollectionShop").text("已关注");
                    }
                    if (data.code == 1) {
                        $("#isCollectionShop").text("关注")
                    }

                };
                sc.post(url, {
                    "UserId": userId,
                    "Token": token,
                    "ShopId": shopId
                }, calback);
            }
        </script>
    </body>

</html>